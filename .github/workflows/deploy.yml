name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ ÐºÐ¾Ð´Ñƒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–ÑŽ
        uses: actions/checkout@v4

      # === ÐšÐ ÐžÐš 1: ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾, Ñ‡Ð¸ ÑÐµÐºÑ€ÐµÑ‚ SSH_PRIVATE_KEY Ð½ÐµÐ¿ÑƒÑÑ‚Ð¸Ð¹ ===
      - name: "Debug: Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° SSH_PRIVATE_KEY"
      # === ÐšÐ ÐžÐš 1: ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾, Ñ‡Ð¸ ÑÐµÐºÑ€ÐµÑ‚ SSH_PRIVATE_KEY Ð½ÐµÐ¿ÑƒÑÑ‚Ð¸Ð¹ ===
      - name: "Debug: Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° SSH_PRIVATE_KEY"
        run: |
          echo '>>> SECRET START <<<'
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | head -n 3
          lines=$(echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -l)
          echo "... Ð²ÑÑŒÐ¾Ð³Ð¾ $lines Ñ€ÑÐ´ÐºÑ–Ð² Ñƒ ÑÐµÐºÑ€ÐµÑ‚Ñ–"
          echo '>>> SECRET END <<<'
          echo '>>> SECRET START <<<'
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | head -n 3
          lines=$(echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -l)
          echo "... Ð²ÑÑŒÐ¾Ð³Ð¾ $lines Ñ€ÑÐ´ÐºÑ–Ð² Ñƒ ÑÐµÐºÑ€ÐµÑ‚Ñ–"
          echo '>>> SECRET END <<<'

      # === ÐšÐ ÐžÐš 2: Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ñƒ known_hosts ===
      - name: Debug: Ð´Ð¾Ð´Ð°Ñ‚Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ñƒ known_hosts
      # === ÐšÐ ÐžÐš 2: Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ñƒ known_hosts ===
      - name: Debug: Ð´Ð¾Ð´Ð°Ñ‚Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ñƒ known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 38.242.214.198 >> ~/.ssh/known_hosts
          echo '>>> KNOWN_HOSTS CONTENT <<<'
          echo '>>> KNOWN_HOSTS CONTENT <<<'
          cat ~/.ssh/known_hosts
          echo '>>> END KNOWN_HOSTS <<<'
          echo '>>> END KNOWN_HOSTS <<<'

      # === ÐšÐ ÐžÐš 3: Ð¡Ð¿Ñ€Ð¾Ð±Ð° Ñ‡Ð¸ÑÑ‚Ð¾Ð³Ð¾ SSH-Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ===
      - name: Debug: Ð¿Ñ€Ð¾Ð±Ð½Ð¸Ð¹ ssh-Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ
      # === ÐšÐ ÐžÐš 3: Ð¡Ð¿Ñ€Ð¾Ð±Ð° Ñ‡Ð¸ÑÑ‚Ð¾Ð³Ð¾ SSH-Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ===
      - name: Debug: Ð¿Ñ€Ð¾Ð±Ð½Ð¸Ð¹ ssh-Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ
        run: |
          ssh -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
              -o StrictHostKeyChecking=yes \
          ssh -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o BatchMode=yes \
              root@38.242.214.198 'echo "SSH connection OK"' \
              || echo 'SSH test failed'
              || echo 'SSH test failed'

      # === ÐšÐ ÐžÐš 4: Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ appleboy/ssh-action Ð· debug-Ñ„Ð»Ð°Ð³Ð¾Ð¼ ===
      - name: "ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð´Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ð¹"
      # === ÐšÐ ÐžÐš 4: Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ appleboy/ssh-action Ð· debug-Ñ„Ð»Ð°Ð³Ð¾Ð¼ ===
      - name: "ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð´Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ð¹"
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: 38.242.214.198
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          debug: true
          script: |
            echo "ðŸš€ ÐŸÐ¾Ñ‡Ð¸Ð½Ð°Ñ”Ð¼Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
            whoami
            pwd
            ls -la
            whoami
            pwd
            ls -la
            cd /var/www/shina-mix-landing/front
            echo "ðŸ“¥ ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð½Ñ– Ð·Ð¼Ñ–Ð½Ð¸ Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–ÑŽ..."
            git fetch --all
            git reset --hard origin/main
            echo "Ð—ÑƒÐ¿Ð¸Ð½ÑÑ”Ð¼Ð¾ Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ–Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑ Next.js..."
            pm2 stop nextjs || true
            pm2 delete nextjs || true
            pm2 stop nextjs || true
            pm2 delete nextjs || true
            echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ ÐºÐµÑˆÑƒ Ñ‚Ð° ÑÑ‚Ð°Ñ€Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²..."
            rm -rf .next
            echo "ðŸ“¦ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ–..."
            npm install --frozen-lockfile
            echo "âš™ï¸ Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð±Ñ–Ð»Ð´ Next.js..."
            npm run build
            echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Next.js Ñ‡ÐµÑ€ÐµÐ· PM2..."
            pm2 start npm --name "nextjs" -- run start
            echo "ðŸ’¾ Ð—Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ ÑÑ‚Ð°Ð½Ñƒ PM2..."
            pm2 save
            echo "ðŸŒ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Nginx, ÑÐºÑ‰Ð¾ Ð±ÑƒÐ»Ð¸ Ð·Ð¼Ñ–Ð½Ð¸..."
            if [[ $(git diff --name-only HEAD^ HEAD | grep "nginx") ]]; then
              sudo systemctl restart nginx || true
              echo "âœ… Nginx Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾!"
            else
              echo "âš¡ Nginx Ð½Ðµ Ð·Ð¼Ñ–Ð½ÑŽÐ²Ð°Ð²ÑÑ, Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð½Ðµ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±ÐµÐ½."
            fi
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾!"
